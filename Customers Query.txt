/*
Query Overview:
This query retrieves the most recent health score for each eligible Mid-Market customer,
excluding certain customers identified with duplicate or invalid records. It filters the
CUSTOMERS table to active, non-onboarding accounts with valid Pinnacle user counts and
joins the latest health score snapshot from the REPORTS.HEALTH_SCORE_SNAPSHOTS table.
*/

-- Get the latest health score snapshot per customer
WITH latest_hs AS (
  SELECT
    hs.*,
    ROW_NUMBER() 
      OVER (
        PARTITION BY hs.maxio_id 
        ORDER BY hs.DATE_EOM DESC
      ) AS rn
  FROM REPORTS.HEALTH_SCORE_SNAPSHOTS AS hs
),

-- List of customer IDs to exclude (duplicate MAXIO_IDs)
excluded_ids AS (
    SELECT COLUMN1 AS MAXIO_ID FROM VALUES
      ('2015-6406'),
      ('2015-6606'),
      ('2015-15328'),
      ('2015-7480'),
      ('2015-11412'),
      ('2015-11346'),
      ('2015-5480'),
      ('2015-8195')
)

-- Final select: join customers with their latest health score, exclude flagged IDs
SELECT
  c.Maxio_ID,
  c.NAME,
  c.segment,
  c.CUSTOMER_SUCCESS_MANAGER,
  c.PINNACLE_USERS,
  c.ACTIVE_ARR,
  c.RENEWAL_DATE,
  lh.TOTAL_SCORE
FROM CUSTOMERS AS c
JOIN latest_hs AS lh
  ON c.MAXIO_ID = lh.MAXIO_ID
  AND lh.rn = 1     -- Only keep most recent score
LEFT JOIN excluded_ids e ON c.MAXIO_ID = e
